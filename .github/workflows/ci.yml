name: CI Enforcement - Shift-Left Security

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: Install Project Dependencies
        run: |
          pip install -r requirements.txt
          pip install -e .

      # 1. Run Pylint and fail if score is below 10
      - name: Action 1: Quality Check (Pylint)
        run: pylint src/ --fail-under=10

      # 2. Run your tests (Basic Pytest)
      - name: Action 2: Run Functional Tests (Pytest)
        run: pytest

      # 3. Generate dependency.svg (and fail if missing)
      - name: Action 3: Dependency Visualization (pydeps)
        run: |
          pydeps src/app.py --noshow -T svg -o dependency.svg
          if [ ! -f dependency.svg ]; then echo "SVG missing" && exit 1; fi

      # 4. Run snyk test (Produce output)
      - name: Action 4: Security Scan (Snyk)
        uses: snyk/actions/python-3.10@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=high

      # 5. Run Pytest and fail if coverage is below 100
      - name: Action 5: Coverage Enforcement (100% Required)
        run: pytest --cov=src --cov-fail-under=100
