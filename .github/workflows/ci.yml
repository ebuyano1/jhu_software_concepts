name: CI Enforcement - Shift-Left Security

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./module_5

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: Install Project Dependencies
        run: |
          pip install -r requirements.txt
          pip install -e .

      # Requirement 1: Enforce Linting
      - name: "Action 1: Quality Check (Pylint)"
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src
          pylint src/ --fail-under=10 

      # Requirement 2: Enforce Tests
      - name: "Action 2: Run Functional Tests (Pytest)"
        env:
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: password
          PGPORT: 5432
          PGDATABASE: postgres
        run: pytest

      # Requirement 3: Enforce Dependency Graph
      - name: "Action 3: Dependency Visualization"
        run: |
          pydeps src/app.py --noshow -o dependency.svg
          if [ ! -f dependency.svg ]; then echo "Graph generation failed"; exit 1; fi

      # Requirement 4a: Dependency Security (SCA)
      - name: "Action 4a: Snyk Open Source Scan"
        uses: snyk/actions/python-3.10@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --file=module_5/requirements.txt --skip-unresolved

      # Requirement 4b: Custom Code Security (SAST) - ADDED THIS
      - name: "Action 4b: Snyk Code Scan"
        uses: snyk/actions/python-3.10@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: module_5/src 

      # Requirement 5: Enforce Coverage
      - name: "Action 5: Coverage Enforcement (100%)"
        env:
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: password
          PGPORT: 5432
          PGDATABASE: postgres
        run: pytest --cov=src --cov-fail-under=100

      # Requirement 6: Upload the graph so it can be verified
      - name: "Action 6: Upload Dependency Graph"
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph
          path: module_5/dependency.svg