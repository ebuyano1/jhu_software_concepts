name: CI Enforcement - Shift-Left Security

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    # This handles the fact that everything is inside the module_5 folder
    defaults:
      run:
        working-directory: ./module_5

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: Install Project Dependencies
        run: |
          pip install -r requirements.txt
          pip install -e .

      - name: "Action 1: Quality Check (Pylint)"
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src
          pylint src/ --fail-under=10

      - name: "Action 2: Run Functional Tests (Pytest)"
        env:
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: password
          PGPORT: 5432
        run: pytest

      - name: "Action 3: Dependency Visualization"
        run: |
          pydeps src/app.py --noshow -T svg -o dependency.svg
          if [ ! -f dependency.svg ]; then exit 1; fi

      - name: "Action 4: Security Scan (Snyk)"
        uses: snyk/actions/python-3.10@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --file=module_5/requirements.txt

      - name: "Action 5: Coverage Enforcement (100% Required)"
        env:
          PGHOST: localhost
          PGUSER: postgres
          PGPORT: 5432
          PGPASSWORD: password
        run: pytest --cov=src --cov-fail-under=100